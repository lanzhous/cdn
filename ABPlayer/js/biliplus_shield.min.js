var shield=function(){var e,i=/[\x00-\x2f\x3a-\x40\x5b-\x5e\x60\x7b-\x7f]/g,t=!0,o=!0,s=null,n=0,r=!1,l=function(e){return document.querySelector(e)},d=null,a=function(e){return 14==e.length&&"k"==e[3]||("D"==e[0]||"d"==e[0]||"0"==e)};return obj={init:function(i){if(t){void 0!=i&&(d=i),t=!1,obj.tab(0),void 0==localStorage.shieldList&&(localStorage.shieldList='{"text":[],"user":[],"color":[],"useReg":false,"limit":10,"mode":[],"visitor":false}'),s=JSON.parse(localStorage.shieldList),void 0==s.color&&(s.color=[]),void 0==s.useReg&&(s.useReg=!1),void 0==s.limit&&(s.limit=10),void 0==s.mode&&(s.mode=[]),void 0==s.visitor&&(s.visitor=!1),r=s.useReg,e=s.limit,obj.render();var o,a,c;for(c=$(".shield_tab"),o=0,a=c.length;o<a;o++)c[o].tabNum=o,c[o].addEventListener("mouseenter",function(){obj.tab(this.tabNum)}),c[o].addEventListener("mouseleave",function(e){var i=this.getBoundingClientRect(),t=e.clientX,o=e.clientY;(t-i.left<0||t-i.left>i.width||o-i.top<0||o-i.top>i.height)&&obj.tab(n)}),c[o].addEventListener("click",function(){obj.switchTab(this.tabNum)});l("#useReg").addEventListener("click",function(){r=!r,obj.save(),obj.render(3)}),l("#blockTop").addEventListener("click",function(){obj.mode(5)}),l("#blockBottom").addEventListener("click",function(){obj.mode(4)}),l("#blockVisitor").addEventListener("click",function(){obj.visitor()});var u=!1,f=function(i){if(u){var t=l("#repeat").getBoundingClientRect(),o=Math.round((i.clientX-t.left)/t.width*49+2);o<2||o>51||(e=o,51==e&&(e=0),obj.render(3))}};l("#repeat").addEventListener("mousedown",function(e){u=!0,f(e)}),l("#repeat").addEventListener("mouseup",function(){u=!1,obj.save()}),l("#repeat").addEventListener("touchend",function(){u=!1,obj.save()}),l(".shield").addEventListener("mousemove",f)}},switchTab:function(e){n=e,l(".shield_body_wrapper").style.transform="translateX("+e*-278+"px)",l(".shield_body_wrapper").style.webkitTransform="translateX("+e*-278+"px)"},tab:function(e){var i=l(".shield"),t=i.getBoundingClientRect(),o=l(".shield .shield_tab:nth-of-type("+(e+1)+")>div").getBoundingClientRect(),s=o.left-t.left,n=o.width,r=l(".shield .shield_tab_slash");r.style.left=s+"px",r.style.width=n+"px"},render:function(i){var t=!0,o=0;for(void 0!=i&&(t=!1,o=i);;){switch(o){case 0:var n,d,a,c="";for(n=0,d=s.text.length;n<d;n++)c+='<div class="shield_item"><div class="text">'+s.text[n]+'</div><div class="delete"></div></div>';for(l("#shield_text").innerHTML=c,a=$("#shield_text .shield_item .delete"),n=0,d=a.length;n<d;n++)a[n].onclick=obj.del;break;case 1:for(var a,c="",n=0;n<s.user.length;n++)c+='<div class="shield_item"><div class="text">'+s.user[n]+" 用户UID "+s.user[n]+'</div><div class="delete"></div></div>';for(0==n&&(c='<div class="shield_item">'+ABP.Strings.blockUserEmpty+"</div>"),l("#shield_user").innerHTML=c,a=$("#shield_user .shield_item .delete"),n=0,d=a.length;n<d;n++)a[n].onclick=obj.delUser;break;case 2:for(var u,a,c="",n=0;n<s.color.length;n++){for(u=s.color[n].toString(16);u.length<6;)u="0"+u;c+='<div class="shield_color"><div class="color" style="background:#'+u+'">'+s.color[n]+'</div><div class="delete"></div></div>'}for(0==n&&(c='<div class="shield_color">'+ABP.Strings.blockColorEmpty+"</div>"),l("#shield_color").innerHTML=c,a=$("#shield_color .shield_color .delete"),n=0,d=a.length;n<d;n++)a[n].onclick=obj.delColor;break;case 3:l("#useReg").className="shield_toggle"+(r?" on":""),l("#blockTop").className="shield_toggle"+(s.mode.indexOf(5)!=-1?" on":""),l("#blockBottom").className="shield_toggle"+(s.mode.indexOf(4)!=-1?" on":""),l("#blockVisitor").className="shield_toggle"+(s.visitor?" on":"");var f=(e-2)/49,h=e+" "+ABP.Strings.repeatPcs;0==e&&(f=1,h=ABP.Strings.repeatUnlimited),l("#repeat .fill").style.width=100*f+"%",l("#repeat .button").style.left=100*f+"%",l("#repeat .slide_info").innerHTML=h;break;default:return}o++}},save:function(){s.useReg=r,s.limit=e,localStorage.shieldList=JSON.stringify(s),obj.shield()},show:function(){o?$(".shield")[0].setAttribute("class","shield"):$(".shield")[0].setAttribute("class","shield hidden"),o=!o},add:function(){obj.addText(l(".shield_item .new").value)&&(l(".shield_item .new").value="")},addText:function(e){if(""==e||s.text.indexOf(e)!=-1)return!1;try{r&&new RegExp(e)}catch(e){return d.createPopup("格式错误，"+e.message,3e3),!1}return s.text.push(e),obj.save(),obj.render(0),!0},addUser:function(e){return s.user.indexOf(e)==-1&&(s.user.push(e),obj.save(),void obj.render(1))},addColor:function(e){return e=parseInt(e,16),!isNaN(e)&&s.color.indexOf(e)==-1&&(s.color.push(e),obj.save(),void obj.render(2))},mode:function(e){var i,t=(i=s.mode.indexOf(e))==-1;t?s.mode.push(e):s.mode.splice(i,1),obj.save(),obj.render(3)},visitor:function(){s.visitor=!s.visitor,obj.save(),obj.render(3)},del:function(e){var i,t=e.target.parentNode.firstChild.innerHTML,o=s.text.indexOf(t);return o!=-1&&(i=s.text.splice(0,o),s.text=i.concat(s.text.splice(1)),obj.save(),void obj.render(0))},delUser:function(e){var i,t=e.target.parentNode.firstChild.innerHTML.split(" ")[0],o=s.user.indexOf(t);return o!=-1&&(i=s.user.splice(0,o),s.user=i.concat(s.user.splice(1)),obj.save(),void obj.render(1))},delColor:function(e){var i,t=e.target.parentNode.firstChild.innerHTML,o=s.color.indexOf(1*t);return o!=-1&&(i=s.color.splice(0,o),s.color=i.concat(s.color.splice(1)),obj.save(),void obj.render(2))},filter:function(e){return!e.isBlocked&&(e.filtered||(e.oriSize=e.size,e.filtered=!0),e.size=e.oriSize*abpinst.commentScale,e)},shield:function(){if(null==d)return!1;var t,o,n=d.cmManager.timeline,l=[],c=0,u=[],f=n.length,h={},v=d.cmManager.runline;if(e>0){for(;c<f;c++)try{l.push(n[c].text.replace(i,""))}catch(e){}for(var b=0,m=b,g={};m!=f;){for(;n[b].stime+1e4<n[m].stime;)0==--g[l[b]]&&delete g[l[b]],++b;void 0==g[l[m]]&&(g[l[m]]=0),++g[l[m]]>e&&n[m].mode<=6&&(h[l[m]]=1),++m}}for(t=0;t<s.text.length;t++)u.push(r?new RegExp(s.text[t]):s.text[t]);for(c=0;c<f;c++)if(o=n[c],o.isBlocked=!1,(void 0!=h[l[c]]||s.color.indexOf(o.color)!=-1||s.user.indexOf(o.hash)!=-1||s.mode.indexOf(o.mode)!=-1||s.visitor&&a(o.hash))&&(o.isBlocked=!0),void 0!=h[l[c]])o.isBlocked=!0,o.blockReason="重复弹幕";else if(s.color.indexOf(o.color)!=-1)o.isBlocked=!0,o.blockReason="颜色";else if(s.user.indexOf(o.hash)!=-1)o.isBlocked=!0,o.blockReason="用户";else if(s.mode.indexOf(o.mode)!=-1)o.isBlocked=!0,o.blockReason="位置";else if(s.visitor&&a(o.hash))o.isBlocked=!0,o.blockReason="游客";else for(t=0;t<u.length;t++)try{if(null!=o.text.match(u[t])){o.isBlocked=!0,o.blockReason=u[t];break}}catch(e){}for(c=v.length-1;c>=0;c--)v[c].originalData.isBlocked&&v[c].finish();d.renderCommentList()}},obj}();window.shield=shield;